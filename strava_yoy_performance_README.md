# Strava Year-over-Year Performance

## Purpose
This bookmarklet provides a detailed year-over-year (YoY) performance analysis for segments on the current Strava activity page. It compares your power and time for each significant segment against your average for the same segments over the last 365 days.

## Features
- **YoY Comparison**: Analyzes your performance on the current ride versus your average for the past year.
- **Dual Metric Analysis**: Compares both average power and elapsed time.
- **Percentage Improvement**: Calculates and displays the percentage difference from your yearly average for both power and time.
- **Positional Ranking**: Shows where your current effort ranks among all your efforts on that segment in the last year (e.g., "1st", "3rd", "10th").
- **Clear UI**: Displays the results in a clean, easy-to-read table inside a popup on the activity page.
- **Direct Links**: Provides a direct link to the full effort history for each analyzed segment.

## Installation

### Easy Install
Drag this link to your bookmarks bar: [Strava YoY Performance](javascript:(function()%7Bconst%20t%3D270%3Bfunction%20e()%7Bconst%20e%3Dnull%3F.pageView%3F._powerController%3F.attributes%3Breturn!e%3F.weighted_power%7C%7C!e%3F.relative_intensity%3Ft:100*(e.weighted_power/e.relative_intensity)%7Dfunction%20o(t)%7Bt%3DMath.round(t)%3Bconst%20e%3DMath.floor(t/3600),o%3DMath.floor(t%3600/60),n%3Dt%3600%3Breturn%20e>0%3F%60%24%7Be%7D:%24%7Bo.toString().padStart(2,%220%22)%7D:%24%7Bn.toString().padStart(2,%220%22)%7D%60:%60%24%7Bo%7D:%24%7Bn.toString().padStart(2,%220%22)%7D%60%7Dfunction%20n(t)%7Bconst%20e%3Ddocument.createElement(%22div%22)%3Be.style.cssText%3D%22%5Cn%20%20%20%20%20%20%20%20position:%20fixed;%5Cn%20%20%20%20%20%20%20%20top:%2020px;%5Cn%20%20%20%20%20%20%20%20right:%2020px;%5Cn%20%20%20%20%20%20%20%20background:%20white;%5Cn%20%20%20%20%20%20%20%20padding:%2015px;%5Cn%20%20%20%20%20%20%20%20border-radius:%208px;%5Cn%20%20%20%20%20%20%20%20box-shadow:%200%202px%2010px%20rgba(0,0,0,0.1);%5Cn%20%20%20%20%20%20%20%20max-height:%2080vh;%5Cn%20%20%20%20%20%20%20%20overflow-y:%20auto;%5Cn%20%20%20%20%20%20%20%20z-index:%209999;%5Cn%20%20%20%20%20%20%20%20font-family:%20-apple-system,%20BlinkMacSystemFont,%20%22Segoe%20UI%22,%20Roboto,%20sans-serif;%5Cn%20%20%20%20%22,e.innerHTML%3D%22%5Cn%20%20%20%20%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-table%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-collapse:%20collapse;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin:%2010px%200;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min-width:%20500px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-table%20th,%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-table%20td%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%204px%208px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%201px%20solid%20%23ddd;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-align:%20right;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-table%20th:first-child,%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-table%20td:first-child%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-align:%20left;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.positive%20%7B%20color:%20%232ecc71;%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.negative%20%7B%20color:%20%23e74c3c;%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.close-btn%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20position:%20absolute;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20top:%205px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20right:%205px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%205px%2010px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20background:%20none;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2020px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20%23666;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.segment-name%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2016px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-weight:%20bold;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin:%2015px%200%205px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.efforts-count%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2014px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20%23666;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-bottom:%205px;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.efforts-link%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20%23666;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-decoration:%20none;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20.efforts-link:hover%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-decoration:%20underline;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20%23333;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%3C/style%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20class%3D%22close-btn%22%3E%C3%97%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Ch2%20style%3D%22margin-top:%200;%22%3ESegment%20YoY%20Performance%20Analysis%3C/h2%3E%5Cn%20%20%20%20%22,t.forEach((t%3D>%7Bconst%20o%3D%60%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22segment-name%22%3E%24%7Bt.segmentName%7D%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22efforts-count%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ca%20href%3D%22https://www.strava.com/segments/%24%7Bt.segmentId%7D%3Ffilter%3Dmy_results%22%20%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20class%3D%22efforts-link%22%20%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target%3D%22_blank%22%3E%24%7Bt.totalEfforts%7D%20efforts%3C/a%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Ctable%20class%3D%22segment-table%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cthead%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%3E%3C/th%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%3EThis%20Ride%3C/th%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%3EYoY%20Avg%3C/th%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%3EDiff%3C/th%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%3EYoY%20Pos%3C/th%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/thead%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctbody%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3EPower%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.currentPower%3Ft.currentPower.toFixed(1)%2B%22W%22:%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.averagePower%3Ft.averagePower.toFixed(1)%2B%22W%22:%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class%3D%22%24%7Bt.powerImprovement%3E%3D0%3F%22positive%22:%22negative%22%7D%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24%7Bt.powerImprovement%3F(t.powerImprovement%3E%3D0%3F%22+%22:%22%22)%2Bt.powerImprovement.toFixed(1)%2B%22%25%22:%22N/A%22%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.powerRank%7C%7C%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3ETime%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.currentTime%3Fo(t.currentTime):%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.averageTime%3Fo(t.averageTime):%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class%3D%22%24%7Bt.timeImprovement<%3D0%3F%22positive%22:%22negative%22%7D%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24%7Bt.timeImprovement%3F(t.timeImprovement%3E%3D0%3F%22+%22:%22%22)%2Bt.timeImprovement.toFixed(1)%2B%22%25%22:%22N/A%22%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bt.timeRank%7C%7C%22N/A%22%7D%3C/td%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tbody%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C/table%3E%5Cn%20%20%20%20%20%20%20%20%60%3Be.insertAdjacentHTML(%22beforeend%22,o)%7D)),e.querySelector(%22.close-btn%22).onclick%3D()%3D>e.remove(),document.body.appendChild(e)%7Dfunction%20r(t,e)%7Bconst%20o%3Dnew%20Date%3Bo.setFullYear(o.getFullYear()-1)%3Bif(!(null%3F.e%3F.efforts%3F.length))return%20null%3Bconst%20n%3De.efforts.filter((t%3D>new%20Date(t.start_date)>o)),r%3Dn.filter((t%3D>t.avg_watts_calc%26%26!isNaN(t.avg_watts_calc))),s%3D%5B...r%5D.sort(((t,e)%3D>e.avg_watts_calc-t.avg_watts_calc)),a%3D%5B...n%5D.sort(((t,e)%3D>a.elapsed_time-t.elapsed_time)),i%3Dr.length>0%3Fr.reduce(((t,e)%3D>t+e.avg_watts_calc),0)/r.length:null,c%3Dn.length>0%3Fn.reduce(((t,e)%3D>t+e.elapsed_time),0)/n.length:null,l%3Dt.attributes.avg_watts_raw,u%3Dt.attributes.elapsed_time_raw%3Blet%20d%3Dnull,m%3Dnull,p%3Dnull,g%3Dnull%3Bif(l%26%26s.length)%7Bconst%20t%3Ds.findIndex((t%3D>t.avg_watts_calc<%3Dl)),e%3D-1%3D%3D%3Dt%3Fs.length+1:t+1%3Bd%3Dh(e)%7Dif(u%26%26a.length)%7Bconst%20t%3Da.findIndex((t%3D>t.elapsed_time%3E%3Du)),e%3D-1%3D%3D%3Dt%3Fa.length+1:t+1%3Bm%3Dh(e)%7Dif(l%26%26i)p%3D(l-i)/i*100%3Bif(u%26%26c)g%3D(u-c)/c*100%3Breturn%7BcurrentPower:l,currentTime:u,averagePower:i,averageTime:c,powerImprovement:p,timeImprovement:g,totalEfforts:n.length,segmentName:t.attributes.name,segmentId:t.attributes.segment_id,powerRank:d,timeRank:m%7D%7Dfunction%20h(t)%7Bconst%20e%3Dt%10,o%3Dt%100%3Breturn%201%3D%3De%26%2611!%3Do%3Ft+%22st%22:2%3D%3De%26%2612!%3Do%3Ft+%22nd%22:3%3D%3De%26%2613!%3Do%3Ft+%22rd%22:t+%22th%22%7Dasync%20function%20s(t,e)%7Btry%7Bconst%20o%3Dawait%20fetch(%60https://www.strava.com/athlete/segments/%24%7Bt%7D/history%60,%7Bheaders:%7Baccept:%22text/javascript,%20application/javascript%22,%22x-csrf-token%22:e,%22x-requested-with%22:%22XMLHttpRequest%22%7D,credentials:%22include%22%7D)%3Bif(!o.ok)throw%20new%20Error(%60HTTP%20error!%20status:%20%24%7Bo.status%7D%60)%3Breturn%20await%20o.json()%7Dcatch(e)%7Breturn%20console.error(%60Failed%20to%20fetch%20history%20for%20segment%20%24%7Bt%7D:%60,e),null%7D%7D(async()%3D>%7Bvar%20t%3Bconst%20o%3Dnull%3F.(t%3Ddocument.querySelector('meta%5Bname%3D%22csrf-token%22%5D'))%3F.content%3Bif(!o)return%20void%20alert(%22Unable%20to%20find%20CSRF%20token.%20Please%20ensure%20you%20are%20on%20a%20Strava%20activity%20page.%22)%3Bconst%20a%3De(),i%3Dnull%3F.pageView%3F.segmentEfforts()%3F.models%3Bif(!(null%3F.i%3F.length))return%20void%20alert(%22No%20segment%20efforts%20found%20on%20this%20page.%22)%3Bconst%20c%3Di.filter((t%3D>%7Bconst%20e%3Dt.attributes%3Breturn%20e.activity_leaderboard_eligible%26%26e.effort_leaderboard_eligible%26%26!e.hidden%26%26!e.flagged%26%26(!e.avg_watts_raw%7C%7Ce.avg_watts_raw>a)%7D))%3Bif(!c.length)return%20void%20alert(%22No%20segments%20found%20matching%20criteria.%22)%3Bconst%20l%3Dawait%20Promise.all(c.map((async%20t%3D>%7Bconst%20e%3Dawait%20s(t.attributes.segment_id,o)%3Breturn%20e%3Fr(t,e):null%7D)))%3Bconst%20u%3Dl.filter(Boolean)%3B0%3D%3D%3Du.length%3Falert(%22No%20valid%20segment%20analyses%20available.%22):n(u)%7D)()%7D)())

### Manual Install
1. Create a new bookmark in your browser.
2. Name it "Strava YoY Performance".
3. Copy the code from `strava_yoy_performance.js` and paste it into the URL field of the bookmark.
4. Make sure to add the `javascript:` prefix at the beginning of the code.

## Usage
1. Log in to your Strava account.
2. Navigate to one of your activity pages that contains segment efforts.
3. Click the "Strava YoY Performance" bookmarklet from your bookmarks bar.
4. A popup will appear on the top-right of the page with a detailed breakdown of your performance on key segments from that ride compared to your history.

## How It Works
The bookmarklet first identifies all the eligible segments from the current activity. For each of these segments, it uses Strava's internal API to fetch your entire effort history. It then filters this history to include only the efforts from the last 365 days. It calculates your average power and time over that period and compares it to the power and time from your current effort, showing the difference as a percentage. It also determines the rank of your current effort for a final comparison.

## Technical Notes
- **Login Required**: You must be logged into Strava for the bookmarklet to be able to fetch your segment history.
- **API Dependency**: This tool relies on Strava's internal, undocumented API. If Strava changes its API, this bookmarklet may break.
- **FTP Estimation**: The script attempts to calculate your FTP from the data available on the page to filter relevant segments. If it cannot, it falls back to a default value of `270W`. You can change this default value by editing the script.

## License
MIT

## Author
[Your Name/Alias Here]
